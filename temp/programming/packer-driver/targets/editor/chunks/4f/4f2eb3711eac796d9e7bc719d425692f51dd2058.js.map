{"version":3,"sources":["file:///D:/project/claudecode/wx/Cat_Journey/assets/scripts/gameplay/GameManager.ts"],"names":["_decorator","Component","Node","Prefab","instantiate","director","Color","Sprite","PhysicsSystem2D","RelicManager","LevelManager","LevelType","CoreController","Ball","ccclass","property","GameState","GameManager","_currentState","PRE_START","_bricks","_ballNode","_paddleNode","_coreController","_levelManager","getInstance","_instance","onLoad","addPersistRootNode","node","destroy","onDestroy","start","initializeGame","initializeCore","initializeLevelManager","setState","instance","debugDrawFlags","console","log","createBoundaryWalls","createPaddle","createBall","setupLevel","scheduleOnce","launchBall","PLAYING","coreNode","getComponent","warn","paddlePrefab","setPosition","canvas","parent","addChild","error","ballPrefab","wallPrefab","parentNode","leftWall","setScale","leftSprite","color","rightWall","rightSprite","topWall","topSprite","bottomWall","bottomSprite","ballScript","launch","clearBricks","initializeLevel","levelType","getCurrentLevelType","BOSS","layout","getLevelLayout","level","createBricksFromLayout","basicLayout","row","length","col","Math","random","brickPrefab","brickContainer","startX","startY","brickWidth","brickHeight","spacing","brickType","brick","x","y","brickScript","setHealth","setDropsExperience","push","forEach","isValid","onBrickDestroyed","scoreValue","brickPosition","dropsExperience","score","powerUpDropChance","dropPowerUp","dropExperienceOrb","filter","checkLevelComplete","position","powerUps","multiBallPowerUpPrefab","laserPaddlePowerUpPrefab","availablePowerUps","prefab","randomPowerUp","floor","powerUpNode","onBallLost","lives","takeDamage","GAME_OVER","resetBall","onCoreAttacked","damage","onCoreDestroyed","onBossDefeated","onLevelComplete","experienceOrbPrefab","orbNode","NORMAL","LEVEL_COMPLETE","relicManager","grantRandomRelic","resetLevel","adjustDifficulty","newState","validStates","Object","values","includes","oldState","onStateChanged","_oldState","handleGameOver","handleLevelComplete","handleGamePlaying","getCurrentState","getBallPrefab","getScore","getLives","getLevel","getBrickCount","getBricks","getBallNode","getPaddleNode","getCoreController","getLevelManager","getGameState","addScore","points","decreaseLives","amount","max"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Prefab, instantiate, Vec3, director, Color, Sprite, BoxCollider2D, PhysicsSystem2D } from 'cc';\r\nimport { RelicManager } from '../managers/RelicManager';\r\nimport { LevelManager, LevelType } from './LevelManager';\r\nimport { CoreController } from '../managers/CoreController';\r\nimport { Ball } from '../core/Ball';\r\nconst { ccclass, property } = _decorator;\r\n\r\nexport enum GameState {\r\n    PRE_START = 'PRE_START',\r\n    PLAYING = 'PLAYING',\r\n    LEVEL_COMPLETE = 'LEVEL_COMPLETE',\r\n    GAME_OVER = 'GAME_OVER'\r\n}\r\n\r\n@ccclass('GameManager')\r\nexport class GameManager extends Component {\r\n    @property(Prefab)\r\n    public brickPrefab: Prefab | null = null;\r\n\r\n    @property(Prefab)\r\n    public paddlePrefab: Prefab | null = null;\r\n\r\n    @property(Prefab)\r\n    public ballPrefab: Prefab | null = null;\r\n\r\n    @property(Prefab)\r\n    public multiBallPowerUpPrefab: Prefab | null = null;\r\n\r\n    @property(Prefab)\r\n    public laserPaddlePowerUpPrefab: Prefab | null = null;\r\n\r\n    @property(Prefab)\r\n    public wallPrefab: Prefab | null = null;\r\n\r\n    @property(Prefab)\r\n    public deathZonePrefab: Prefab | null = null;\r\n\r\n    @property\r\n    public powerUpDropChance: number = 0.2;\r\n\r\n    @property(Node)\r\n    public brickContainer: Node | null = null;\r\n\r\n    @property(Node)\r\n    public coreNode: Node | null = null;\r\n\r\n    @property(Prefab)\r\n    public experienceOrbPrefab: Prefab | null = null;\r\n\r\n    @property\r\n    public lives: number = 3;\r\n\r\n    @property\r\n    public score: number = 0;\r\n\r\n    @property\r\n    public level: number = 1;\r\n\r\n    private static _instance: GameManager | null = null;\r\n    private _currentState: GameState = GameState.PRE_START;\r\n    private _bricks: Node[] = [];\r\n    private _ballNode: Node | null = null;\r\n    private _paddleNode: Node | null = null;\r\n    private _coreController: CoreController | null = null;\r\n    private _levelManager: LevelManager | null = null;\r\n\r\n    public static getInstance(): GameManager | null {\r\n        return GameManager._instance;\r\n    }\r\n\r\n    protected onLoad(): void {\r\n        if (GameManager._instance === null) {\r\n            GameManager._instance = this;\r\n            director.addPersistRootNode(this.node);\r\n        } else {\r\n            this.node.destroy();\r\n            return;\r\n        }\r\n    }\r\n\r\n    protected onDestroy(): void {\r\n        if (GameManager._instance === this) {\r\n            GameManager._instance = null;\r\n        }\r\n    }\r\n\r\n    protected start(): void {\r\n        this.initializeGame();\r\n        this.initializeCore();\r\n        this.initializeLevelManager();\r\n    }\r\n\r\n    private initializeGame(): void {\r\n        this.setState(GameState.PRE_START);\r\n        \r\n        // 启用物理调试显示\r\n        PhysicsSystem2D.instance.debugDrawFlags = 1; // 启用调试绘制\r\n        console.log('Physics debug draw enabled');\r\n        \r\n        this.createBoundaryWalls();\r\n        this.createPaddle();\r\n        this.createBall();\r\n        this.setupLevel();\r\n        \r\n        // 延迟发射球，确保所有物理对象都已初始化\r\n        this.scheduleOnce(() => {\r\n            this.launchBall();\r\n            this.setState(GameState.PLAYING);\r\n        }, 2.0);\r\n    }\r\n\r\n    private initializeCore(): void {\r\n        if (this.coreNode) {\r\n            this._coreController = this.coreNode.getComponent(CoreController);\r\n            if (!this._coreController) {\r\n                console.warn('CoreController not found on coreNode');\r\n            }\r\n        }\r\n    }\r\n\r\n    private initializeLevelManager(): void {\r\n        this._levelManager = LevelManager.getInstance();\r\n        if (!this._levelManager) {\r\n            console.warn('LevelManager instance not found');\r\n        }\r\n    }\r\n\r\n    private createPaddle(): void {\r\n        try {\r\n            if (!this.paddlePrefab) {\r\n                console.warn('Paddle prefab not assigned - skipping paddle creation');\r\n                return;\r\n            }\r\n            \r\n            this._paddleNode = instantiate(this.paddlePrefab);\r\n            if (this._paddleNode) {\r\n                this._paddleNode.setPosition(0, -300, 0);\r\n                // 统一添加到Canvas下\r\n                const canvas = this.node.parent;\r\n                if (canvas) {\r\n                    canvas.addChild(this._paddleNode);\r\n                    console.log('Paddle created successfully and added to Canvas');\r\n                } else {\r\n                    this.node.addChild(this._paddleNode);\r\n                    console.log('Paddle created successfully and added to GameManager');\r\n                }\r\n            } else {\r\n                console.error('Failed to instantiate paddle prefab');\r\n            }\r\n            \r\n        } catch (error) {\r\n            console.error('Error creating paddle:', error);\r\n        }\r\n    }\r\n\r\n    private createBall(): void {\r\n        try {\r\n            if (!this.ballPrefab) {\r\n                console.warn('Ball prefab not assigned - skipping ball creation');\r\n                return;\r\n            }\r\n            \r\n            this._ballNode = instantiate(this.ballPrefab);\r\n            if (this._ballNode) {\r\n                this._ballNode.setPosition(0, -100, 0); // 相对Canvas中心的位置\r\n                // 将Ball添加到Canvas下，而不是GameManager下\r\n                const canvas = this.node.parent;\r\n                if (canvas) {\r\n                    canvas.addChild(this._ballNode);\r\n                    console.log('Ball created successfully and added to Canvas');\r\n                } else {\r\n                    this.node.addChild(this._ballNode);\r\n                    console.log('Ball created successfully and added to GameManager');\r\n                }\r\n            } else {\r\n                console.error('Failed to instantiate ball prefab');\r\n            }\r\n            \r\n        } catch (error) {\r\n            console.error('Error creating ball:', error);\r\n        }\r\n    }\r\n\r\n    private createBoundaryWalls(): void {\r\n        try {\r\n            if (!this.wallPrefab) {\r\n                console.warn('Wall prefab not assigned - skipping boundary creation');\r\n                return;\r\n            }\r\n\r\n            // Screen boundaries for 640x960 portrait: left=-320, right=+320, top=+480, bottom=-480\r\n            const canvas = this.node.parent;\r\n            const parentNode = canvas || this.node;\r\n            \r\n            // Left wall\r\n            const leftWall = instantiate(this.wallPrefab);\r\n            leftWall.setPosition(-325, 0, 0); // 竖屏左边界\r\n            leftWall.setScale(1, 10, 1); // 高一些适应竖屏\r\n            const leftSprite = leftWall.getComponent(Sprite);\r\n            if (leftSprite) {\r\n                leftSprite.color = new Color(255, 0, 0, 128);\r\n            }\r\n            parentNode.addChild(leftWall);\r\n\r\n            // Right wall  \r\n            const rightWall = instantiate(this.wallPrefab);\r\n            rightWall.setPosition(325, 0, 0); // 竖屏右边界\r\n            rightWall.setScale(1, 10, 1);\r\n            const rightSprite = rightWall.getComponent(Sprite);\r\n            if (rightSprite) {\r\n                rightSprite.color = new Color(255, 0, 0, 128);\r\n            }\r\n            parentNode.addChild(rightWall);\r\n\r\n            // Top wall\r\n            const topWall = instantiate(this.wallPrefab);\r\n            topWall.setPosition(0, 485, 0); // 竖屏上边界\r\n            topWall.setScale(7, 1, 1); // 宽一些覆盖竖屏宽度\r\n            const topSprite = topWall.getComponent(Sprite);\r\n            if (topSprite) {\r\n                topSprite.color = new Color(0, 255, 0, 128);\r\n            }\r\n            parentNode.addChild(topWall);\r\n\r\n            // Bottom wall\r\n            const bottomWall = instantiate(this.wallPrefab);\r\n            bottomWall.setPosition(0, -485, 0); // 竖屏下边界\r\n            bottomWall.setScale(7, 1, 1);\r\n            const bottomSprite = bottomWall.getComponent(Sprite);\r\n            if (bottomSprite) {\r\n                bottomSprite.color = new Color(0, 0, 255, 128);\r\n            }\r\n            parentNode.addChild(bottomWall);\r\n\r\n            console.log('Boundary walls created successfully');\r\n        } catch (error) {\r\n            console.error('Error creating boundary walls:', error);\r\n        }\r\n    }\r\n\r\n    private launchBall(): void {\r\n        if (this._ballNode) {\r\n            const ballScript = this._ballNode.getComponent(Ball);\r\n            if (ballScript && typeof ballScript.launch === 'function') {\r\n                ballScript.launch();\r\n                console.log('Ball launched after physics initialization');\r\n            } else {\r\n                console.warn('Ball script not found or launch method not available');\r\n            }\r\n        } else {\r\n            console.warn('Ball node not found, cannot launch');\r\n        }\r\n    }\r\n\r\n    private setupLevel(): void {\r\n        console.log('SetupLevel called - restoring brick creation for full game testing');\r\n        // 恢复brick创建，测试完整游戏交互\r\n        this.clearBricks();\r\n        \r\n        if (this._levelManager) {\r\n            this._levelManager.initializeLevel();\r\n            \r\n            const levelType = this._levelManager.getCurrentLevelType();\r\n            if (levelType !== LevelType.BOSS) {\r\n                const layout = this.getLevelLayout(this.level);\r\n                this.createBricksFromLayout(layout);\r\n            }\r\n        } else {\r\n            const layout = this.getLevelLayout(this.level);\r\n            this.createBricksFromLayout(layout);\r\n        }\r\n    }\r\n\r\n    private getLevelLayout(level: number): number[][] {\r\n        const basicLayout = [\r\n            [1, 1, 1, 1, 1, 1, 1, 1],\r\n            [1, 1, 1, 1, 1, 1, 1, 1],\r\n            [1, 1, 1, 1, 1, 1, 1, 1],\r\n            [1, 1, 1, 1, 1, 1, 1, 1]\r\n        ];\r\n\r\n        if (level > 1) {\r\n            for (let row = 0; row < basicLayout.length; row++) {\r\n                for (let col = 0; col < basicLayout[row].length; col++) {\r\n                    if (Math.random() < 0.3) {\r\n                        basicLayout[row][col] = 2;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return basicLayout;\r\n    }\r\n\r\n    private createBricksFromLayout(layout: number[][]): void {\r\n        if (!this.brickPrefab || !this.brickContainer) return;\r\n\r\n        const startX = -280;\r\n        const startY = 200;\r\n        const brickWidth = 80;\r\n        const brickHeight = 40;\r\n        const spacing = 10;\r\n\r\n        for (let row = 0; row < layout.length; row++) {\r\n            for (let col = 0; col < layout[row].length; col++) {\r\n                const brickType = layout[row][col];\r\n                if (brickType === 0) continue;\r\n\r\n                const brick = instantiate(this.brickPrefab);\r\n                const x = startX + col * (brickWidth + spacing);\r\n                const y = startY - row * (brickHeight + spacing);\r\n                \r\n                brick.setPosition(x, y, 0);\r\n                \r\n                const brickScript = brick.getComponent('Brick');\r\n                if (brickScript) {\r\n                    (brickScript as any).setHealth(brickType);\r\n                    \r\n                    // Some bricks drop experience orbs\r\n                    if (Math.random() < 0.1) { // 10% chance\r\n                        (brickScript as any).setDropsExperience(true);\r\n                    }\r\n                }\r\n\r\n                this.brickContainer.addChild(brick);\r\n                this._bricks.push(brick);\r\n            }\r\n        }\r\n    }\r\n\r\n    private clearBricks(): void {\r\n        this._bricks.forEach(brick => {\r\n            if (brick && brick.isValid) {\r\n                brick.destroy();\r\n            }\r\n        });\r\n        this._bricks = [];\r\n    }\r\n\r\n    public onBrickDestroyed(scoreValue: number = 10, brickPosition?: Vec3, dropsExperience: boolean = false): void {\r\n        this.score += scoreValue;\r\n        \r\n        if (brickPosition) {\r\n            // Drop power-ups\r\n            if (Math.random() < this.powerUpDropChance) {\r\n                this.dropPowerUp(brickPosition);\r\n            }\r\n            \r\n            // Drop experience orbs\r\n            if (dropsExperience) {\r\n                this.dropExperienceOrb(brickPosition);\r\n            }\r\n        }\r\n        \r\n        this._bricks = this._bricks.filter(brick => brick && brick.isValid);\r\n        \r\n        if (this._bricks.length === 0) {\r\n            this.checkLevelComplete();\r\n        }\r\n    }\r\n\r\n    private dropPowerUp(position: Vec3): void {\r\n        const powerUps = [this.multiBallPowerUpPrefab, this.laserPaddlePowerUpPrefab];\r\n        const availablePowerUps = powerUps.filter(prefab => prefab !== null);\r\n        \r\n        if (availablePowerUps.length === 0) return;\r\n        \r\n        const randomPowerUp = availablePowerUps[Math.floor(Math.random() * availablePowerUps.length)];\r\n        if (randomPowerUp) {\r\n            const powerUpNode = instantiate(randomPowerUp);\r\n            powerUpNode.setPosition(position);\r\n            this.node.addChild(powerUpNode);\r\n        }\r\n    }\r\n\r\n    public onBallLost(): void {\r\n        this.lives--;\r\n        \r\n        // Ball hitting core also deals damage\r\n        if (this._coreController) {\r\n            this._coreController.takeDamage(1, 'Ball lost');\r\n        }\r\n        \r\n        if (this.lives <= 0) {\r\n            this.setState(GameState.GAME_OVER);\r\n        } else {\r\n            this.resetBall();\r\n        }\r\n    }\r\n    \r\n    public onCoreAttacked(damage: number): void {\r\n        console.log(`Core attacked for ${damage} damage`);\r\n        \r\n        if (this._coreController) {\r\n            this._coreController.takeDamage(damage, 'External attack');\r\n        }\r\n    }\r\n    \r\n    public onCoreDestroyed(): void {\r\n        console.log('Core destroyed! Immediate game over!');\r\n        this.lives = 0;\r\n        this.setState(GameState.GAME_OVER);\r\n    }\r\n    \r\n    public onBossDefeated(scoreValue: number): void {\r\n        console.log(`Boss defeated! Awarded ${scoreValue} points`);\r\n        this.score += scoreValue;\r\n        \r\n        // Boss defeat triggers level completion\r\n        this.onLevelComplete();\r\n    }\r\n    \r\n    private dropExperienceOrb(position: Vec3): void {\r\n        if (!this.experienceOrbPrefab) return;\r\n        \r\n        const orbNode = instantiate(this.experienceOrbPrefab);\r\n        orbNode.setPosition(position);\r\n        this.node.addChild(orbNode);\r\n        console.log('Experience orb dropped');\r\n    }\r\n\r\n    private resetBall(): void {\r\n        if (this._ballNode) {\r\n            const ballScript = this._ballNode.getComponent('Ball');\r\n            if (ballScript) {\r\n                (ballScript as any).resetBall();\r\n            }\r\n        }\r\n    }\r\n\r\n    private checkLevelComplete(): void {\r\n        const levelType = this._levelManager ? this._levelManager.getCurrentLevelType() : LevelType.NORMAL;\r\n        \r\n        if (levelType === LevelType.BOSS) {\r\n            // Boss levels complete when boss is defeated (handled in onBossDefeated)\r\n            return;\r\n        }\r\n        \r\n        this.onLevelComplete();\r\n    }\r\n\r\n    public onLevelComplete(): void {\r\n        this.setState(GameState.LEVEL_COMPLETE);\r\n        this.level++;\r\n        \r\n        const relicManager = RelicManager.getInstance();\r\n        if (relicManager) {\r\n            relicManager.grantRandomRelic();\r\n        }\r\n        \r\n        // Reset level manager for next level\r\n        if (this._levelManager) {\r\n            this._levelManager.resetLevel();\r\n            this._levelManager.adjustDifficulty(this.level);\r\n        }\r\n        \r\n        this.scheduleOnce(() => {\r\n            this.setupLevel();\r\n            this.setState(GameState.PLAYING);\r\n        }, 3.0);\r\n    }\r\n\r\n    public setState(newState: GameState): void {\r\n        try {\r\n            if (!newState || typeof newState !== 'string') {\r\n                console.warn('Invalid game state:', newState);\r\n                return;\r\n            }\r\n\r\n            const validStates = Object.values(GameState);\r\n            if (!validStates.includes(newState as GameState)) {\r\n                console.warn('Unknown game state:', newState);\r\n                return;\r\n            }\r\n\r\n            const oldState = this._currentState;\r\n            this._currentState = newState;\r\n            \r\n            console.log(`Game State Changed: ${oldState} -> ${newState}`);\r\n            \r\n            // Handle state-specific logic\r\n            this.onStateChanged(oldState, newState);\r\n            \r\n        } catch (error) {\r\n            console.error('Error setting game state:', error);\r\n        }\r\n    }\r\n\r\n    private onStateChanged(_oldState: GameState, newState: GameState): void {\r\n        try {\r\n            switch (newState) {\r\n                case GameState.GAME_OVER:\r\n                    this.handleGameOver();\r\n                    break;\r\n                case GameState.LEVEL_COMPLETE:\r\n                    this.handleLevelComplete();\r\n                    break;\r\n                case GameState.PLAYING:\r\n                    this.handleGamePlaying();\r\n                    break;\r\n            }\r\n        } catch (error) {\r\n            console.warn('Error in state change handler:', error);\r\n        }\r\n    }\r\n\r\n    private handleGameOver(): void {\r\n        console.log('Game Over - cleaning up resources');\r\n        // Stop any ongoing animations or sounds\r\n        // Save final score if needed\r\n    }\r\n\r\n    private handleLevelComplete(): void {\r\n        console.log('Level Complete - preparing next level');\r\n        // Award experience, update progression\r\n    }\r\n\r\n    private handleGamePlaying(): void {\r\n        console.log('Game Playing - all systems active');\r\n        // Ensure all game systems are ready\r\n    }\r\n\r\n    public getCurrentState(): GameState {\r\n        return this._currentState;\r\n    }\r\n\r\n    public getBallPrefab(): Prefab | null {\r\n        return this.ballPrefab;\r\n    }\r\n\r\n    public getScore(): number {\r\n        return this.score;\r\n    }\r\n\r\n    public getLives(): number {\r\n        return this.lives;\r\n    }\r\n\r\n    public getLevel(): number {\r\n        return this.level;\r\n    }\r\n\r\n    // 添加测试期望的方法\r\n    public getBrickCount(): number {\r\n        return this._bricks.length;\r\n    }\r\n\r\n    public getBricks(): Node[] {\r\n        return this._bricks;\r\n    }\r\n\r\n    public getBallNode(): Node | null {\r\n        return this._ballNode;\r\n    }\r\n\r\n    public getPaddleNode(): Node | null {\r\n        return this._paddleNode;\r\n    }\r\n\r\n    public getCoreController(): CoreController | null {\r\n        return this._coreController;\r\n    }\r\n\r\n    public getLevelManager(): LevelManager | null {\r\n        return this._levelManager;\r\n    }\r\n\r\n    public getGameState(): GameState {\r\n        return this._currentState;\r\n    }\r\n\r\n    public addScore(points: number): void {\r\n        this.score += points;\r\n        console.log(`Score increased by ${points}. Total: ${this.score}`);\r\n    }\r\n\r\n    public decreaseLives(amount: number = 1): void {\r\n        this.lives = Math.max(0, this.lives - amount);\r\n        console.log(`Lives decreased by ${amount}. Remaining: ${this.lives}`);\r\n        \r\n        if (this.lives <= 0) {\r\n            this.setState(GameState.GAME_OVER);\r\n        }\r\n    }\r\n}"]}