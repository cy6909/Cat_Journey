{"version":3,"sources":["file:///D:/project/claudecode/wx/Cat_Journey/assets/scripts/core/Ball.ts"],"names":["_decorator","Component","RigidBody2D","Vec2","Collider2D","Contact2DType","Vec3","input","Input","RandomLaunchStrategy","ccclass","property","Ball","_rigidBody","isMoving","fireEffectDuration","iceEffectDuration","_isAttachedToPaddle","_paddleNode","_initialBallY","_launchStrategy","_aimDirection","onLoad","getComponent","findPaddleNode","on","EventType","MOUSE_DOWN","onMouseDown","MOUSE_UP","onMouseUp","colliders","node","getComponents","forEach","collider","BEGIN_CONTACT","onBeginContact","gravityScale","linearDamping","angularDamping","console","log","start","enabled","position","y","update","dt","paddlePos","newPos","x","z","setPosition","Math","floor","Date","now","toFixed","warn","_findPaddleNodeActual","velocity","linearVelocity","speed","length","maxSpeed","normalize","multiplyScalar","initialSpeed","onDestroy","off","setLaunchStrategy","strategy","setAimDirection","direction","setPaddleReference","paddleNode","scheduleOnce","canvas","parent","children","child","name","includes","gameManager","scene","getComponentInChildren","getPaddleNode","event","launchBall","context","paddlePosition","ballPosition","mousePosition","aimDirection","params","calculateLaunchParams","launch","normalized","angle","PI","random","cos","sin","atan2","launchWithDefaultDirection","resetBall","applyFireEffect","duration","applyIceEffect","hasFireEffect","hasIceEffect","getFireEffectDuration","getIceEffectDuration","_selfCollider","otherCollider","_contact","otherNode","onPaddleHit","ballPos","paddleWidth","width","offsetX","clampedOffset","max","min","minAngle","maxAngle","targetAngle","newVelocity","abs","value"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, RigidBody2D, Vec2, Collider2D, IPhysics2DContact, Contact2DType, Vec3, input, Input, EventMouse } from 'cc';\r\nimport { LaunchStrategy, LaunchContext, LaunchParams } from './LaunchStrategy';\r\nimport { AimingLaunchStrategy } from './strategies/AimingLaunchStrategy';\r\nimport { RandomLaunchStrategy } from './strategies/RandomLaunchStrategy';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('Ball')\r\nexport class Ball extends Component {\r\n    @property\r\n    public initialSpeed: number = 100;\r\n\r\n    @property\r\n    public maxSpeed: number = 600;\r\n\r\n    @property\r\n    public minSpeed: number = 100;\r\n\r\n    private _rigidBody: RigidBody2D | null = null;\r\n    public isMoving: boolean = false;\r\n    public fireEffectDuration: number = 0;\r\n    public iceEffectDuration: number = 0;\r\n    \r\n    // 跟随挡板相关状态\r\n    private _isAttachedToPaddle: boolean = true;  // 初始状态：粘在挡板上\r\n    private _paddleNode: Node | null = null;\r\n    private _initialBallY: number = 0; // 记录Ball的初始Y位置，不再跟随Paddle的Y\r\n    private _launchStrategy: LaunchStrategy = new RandomLaunchStrategy();\r\n    private _aimDirection: Vec2 | null = null;\r\n\r\n    protected onLoad(): void {\r\n        this._rigidBody = this.getComponent(RigidBody2D);\r\n        \r\n        // 查找挡板节点\r\n        this.findPaddleNode();\r\n        \r\n        // 注册鼠标事件用于发射控制\r\n        input.on(Input.EventType.MOUSE_DOWN, this.onMouseDown, this);\r\n        input.on(Input.EventType.MOUSE_UP, this.onMouseUp, this);\r\n        \r\n        if (this._rigidBody) {\r\n            // 注册碰撞事件\r\n            const colliders = this.node.getComponents(Collider2D);\r\n            colliders.forEach(collider => {\r\n                collider.on(Contact2DType.BEGIN_CONTACT, this.onBeginContact, this);\r\n            });\r\n            \r\n            // 设置刚体属性以实现无摩擦完美弹性碰撞\r\n            this._rigidBody.gravityScale = 0; // 无重力！Breakout游戏不需要重力\r\n            this._rigidBody.linearDamping = 0; // 无阻尼，保持恒定速度\r\n            this._rigidBody.angularDamping = 0; // 无角阻尼\r\n            console.log('Ball initialized: no gravity, no damping, perfect bouncing');\r\n        }\r\n    }\r\n\r\n    protected start(): void {\r\n        // 初始状态禁用物理，等待发射\r\n        if (this._rigidBody) {\r\n            this._rigidBody.enabled = false;\r\n        }\r\n        \r\n        // 记录初始Y位置\r\n        this._initialBallY = this.node.position.y;\r\n        console.log(`Ball ready, attached to paddle. Initial Y: ${this._initialBallY}`);\r\n    }\r\n    \r\n    protected update(dt: number): void {\r\n        // 如果球粘在挡板上，只跟随挡板的X轴移动，Y轴保持初始位置\r\n        if (this._isAttachedToPaddle && this._paddleNode) {\r\n            const paddlePos = this._paddleNode.position;\r\n            // 只跟随X轴，Y轴使用初始位置\r\n            const newPos = new Vec3(paddlePos.x, this._initialBallY, this.node.position.z);\r\n            this.node.setPosition(newPos);\r\n            \r\n            // 每2秒输出一次调试信息\r\n            if (Math.floor(Date.now() / 1000) % 2 === 0 && Date.now() % 1000 < 50) {\r\n                console.log(`Ball following paddle X: paddle(${paddlePos.x.toFixed(1)}, ${paddlePos.y.toFixed(1)}) -> ball(${newPos.x.toFixed(1)}, ${newPos.y.toFixed(1)})`);\r\n            }\r\n        } else if (this._isAttachedToPaddle && !this._paddleNode) {\r\n            // 每3秒输出一次找不到挡板的警告\r\n            if (Math.floor(Date.now() / 1000) % 3 === 0 && Date.now() % 1000 < 50) {\r\n                console.warn('Ball attached but no paddle found, retrying...');\r\n                this._findPaddleNodeActual();\r\n            }\r\n        }\r\n\r\n        // 以下逻辑只在刚体存在且球已发射时执行\r\n        if (!this._rigidBody || this._isAttachedToPaddle) return;\r\n\r\n        // 更新特效持续时间\r\n        if (this.fireEffectDuration > 0) {\r\n            this.fireEffectDuration -= dt;\r\n            if (this.fireEffectDuration < 0) {\r\n                this.fireEffectDuration = 0;\r\n            }\r\n        }\r\n        if (this.iceEffectDuration > 0) {\r\n            this.iceEffectDuration -= dt;\r\n            if (this.iceEffectDuration < 0) {\r\n                this.iceEffectDuration = 0;\r\n            }\r\n        }\r\n\r\n        // 速度控制\r\n        const velocity = this._rigidBody.linearVelocity;\r\n        const speed = velocity.length();\r\n        \r\n        if (speed > this.maxSpeed) {\r\n            velocity.normalize();\r\n            velocity.multiplyScalar(this.maxSpeed);\r\n            this._rigidBody.linearVelocity = velocity;\r\n        } else if (speed < this.initialSpeed * 0.8) {\r\n            velocity.normalize();\r\n            velocity.multiplyScalar(this.initialSpeed);\r\n            this._rigidBody.linearVelocity = velocity;\r\n        }\r\n    }\r\n    \r\n    protected onDestroy(): void {\r\n        // 清理鼠标事件监听\r\n        input.off(Input.EventType.MOUSE_DOWN, this.onMouseDown, this);\r\n        input.off(Input.EventType.MOUSE_UP, this.onMouseUp, this);\r\n    }\r\n    \r\n    public setLaunchStrategy(strategy: LaunchStrategy): void {\r\n        this._launchStrategy = strategy;\r\n    }\r\n\r\n    public setAimDirection(direction: Vec2): void {\r\n        this._aimDirection = direction;\r\n    }\r\n\r\n    // GameManager调用此方法直接设置Paddle引用，避免查找延迟\r\n    public setPaddleReference(paddleNode: Node): void {\r\n        this._paddleNode = paddleNode;\r\n        console.log('✅ Ball paddle reference set directly by GameManager');\r\n    }\r\n    \r\n    private findPaddleNode(): void {\r\n        // 延迟查找挡板，确保所有节点都已创建\r\n        this.scheduleOnce(() => {\r\n            this._findPaddleNodeActual();\r\n        }, 0.1);\r\n    }\r\n    \r\n    private _findPaddleNodeActual(): void {\r\n        // 通过Canvas查找挡板节点\r\n        const canvas = this.node.parent;\r\n        console.log('Ball searching for paddle, canvas children count:', canvas ? canvas.children.length : 0);\r\n        \r\n        if (canvas) {\r\n            // 遍历Canvas的子节点寻找挡板\r\n            for (const child of canvas.children) {\r\n                console.log(`Checking child: ${child.name}, has PaddleController: ${!!child.getComponent('PaddleController')}`);\r\n                if (child.name.includes('Paddle') || child.getComponent('PaddleController')) {\r\n                    this._paddleNode = child;\r\n                    console.log('✅ Ball found paddle node:', child.name);\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // 如果还是找不到，尝试通过GameManager获取\r\n        const gameManager = this.node.scene.getComponentInChildren('GameManager');\r\n        if (gameManager && (gameManager as any).getPaddleNode) {\r\n            this._paddleNode = (gameManager as any).getPaddleNode();\r\n            console.log('✅ Ball found paddle via GameManager');\r\n            return;\r\n        }\r\n        \r\n        console.warn('❌ Ball could not find paddle node');\r\n    }\r\n    \r\n    private onMouseDown(event: EventMouse): void {\r\n        if (this._isAttachedToPaddle) {\r\n            console.log('Mouse down - preparing to launch ball');\r\n        }\r\n    }\r\n    \r\n    private onMouseUp(event: EventMouse): void {\r\n        if (this._isAttachedToPaddle) {\r\n            this.launchBall();\r\n        }\r\n    }\r\n    \r\n    private launchBall(): void {\r\n        this._isAttachedToPaddle = false;\r\n        \r\n        // 启用物理\r\n        if (this._rigidBody) {\r\n            this._rigidBody.enabled = true;\r\n        }\r\n        \r\n        const context: LaunchContext = {\r\n            paddlePosition: this._paddleNode? new Vec2(this._paddleNode.position.x, this._paddleNode.position.y) : new Vec2(0, 0),\r\n            ballPosition: new Vec2(0,0),\r\n            mousePosition: new Vec2(0,0),\r\n            aimDirection: this._aimDirection || new Vec2(0, 1)\r\n        };\r\n        const params = this._launchStrategy.calculateLaunchParams(context);\r\n        \r\n        this.launch(params.direction);\r\n        console.log('Aiming relic activated - Ball launch strategy changed');\r\n    }\r\n\r\n    public launch(direction?: Vec2): void {\r\n        if (!this._rigidBody) return;\r\n\r\n        let velocity: Vec2;\r\n        if (direction && (direction.x !== 0 || direction.y !== 0)) {\r\n            // 使用指定方向\r\n            const normalized = direction.normalize();\r\n            velocity = new Vec2(\r\n                normalized.x * this.initialSpeed,\r\n                normalized.y * this.initialSpeed\r\n            );\r\n        } else {\r\n            // 使用默认随机方向\r\n            const angle = Math.PI / 4 + Math.random() * (Math.PI / 2);\r\n            velocity = new Vec2(\r\n                Math.cos(angle) * this.initialSpeed,\r\n                Math.sin(angle) * this.initialSpeed\r\n            );\r\n        }\r\n\r\n        this._rigidBody.linearVelocity = velocity;\r\n        this.isMoving = true;\r\n        \r\n        console.log(`Ball launched from position: (${this.node.position.x}, ${this.node.position.y})`);\r\n        console.log(`Ball velocity: (${velocity.x}, ${velocity.y}), angle: ${Math.atan2(velocity.y, velocity.x) * 180 / Math.PI}°`);\r\n    }\r\n\r\n    public launchWithDefaultDirection(): void {\r\n        this.launch();\r\n    }\r\n\r\n    public resetBall(): void {\r\n        if (!this._rigidBody) return;\r\n        \r\n        this.node.setPosition(0, 0, 0);\r\n        this._rigidBody.linearVelocity = new Vec2(0, 0);\r\n        this.isMoving = false;\r\n        this.scheduleOnce(() => this.launch(), 1.0);\r\n    }\r\n\r\n    // 特效系统方法\r\n    public applyFireEffect(duration: number): void {\r\n        if (typeof duration === 'number' && duration > 0) {\r\n            this.fireEffectDuration = duration;\r\n        }\r\n    }\r\n\r\n    public applyIceEffect(duration: number): void {\r\n        if (typeof duration === 'number' && duration > 0) {\r\n            this.iceEffectDuration = duration;\r\n        }\r\n    }\r\n\r\n    public hasFireEffect(): boolean {\r\n        return this.fireEffectDuration > 0;\r\n    }\r\n\r\n    public hasIceEffect(): boolean {\r\n        return this.iceEffectDuration > 0;\r\n    }\r\n\r\n    public getFireEffectDuration(): number {\r\n        return this.fireEffectDuration;\r\n    }\r\n\r\n    public getIceEffectDuration(): number {\r\n        return this.iceEffectDuration;\r\n    }\r\n\r\n    // 碰撞处理方法 - 修复测试失败的核心问题\r\n    public onBeginContact(_selfCollider: Collider2D, otherCollider: Collider2D, _contact: IPhysics2DContact | null): void {\r\n        if (!otherCollider || !otherCollider.node) {\r\n            return;\r\n        }\r\n\r\n        const otherNode = otherCollider.node;\r\n        if (otherNode.name === 'Paddle' || otherNode.getComponent('PaddleController')) {\r\n            this.onPaddleHit(otherNode);\r\n        }\r\n    }\r\n\r\n    private onPaddleHit(paddleNode: Node): void {\r\n        if (!this._rigidBody || !paddleNode) return;\r\n\r\n        const velocity = this._rigidBody.linearVelocity;\r\n        const ballPos = this.node.position;\r\n        const paddlePos = paddleNode.position;\r\n\r\n        // 计算球相对于挡板中心的偏移量 (-1到1之间)\r\n        const paddleWidth = paddleNode.getComponent('UITransform')?.width || 100;\r\n        const offsetX = (ballPos.x - paddlePos.x) / (paddleWidth / 2);\r\n        const clampedOffset = Math.max(-1, Math.min(1, offsetX));\r\n\r\n        // 根据碰撞位置调整反弹角度 (20度到160度之间)\r\n        const minAngle = 20 * Math.PI / 180;  // 最小角度20度\r\n        const maxAngle = 160 * Math.PI / 180; // 最大角度160度\r\n        const targetAngle = minAngle + (1 - (clampedOffset + 1) / 2) * (maxAngle - minAngle);\r\n\r\n        // 保持当前速度大小，只改变方向\r\n        const speed = velocity.length();\r\n        const newVelocity = new Vec2(\r\n            Math.cos(targetAngle) * speed,\r\n            Math.sin(targetAngle) * speed\r\n        );\r\n\r\n        // 确保Y方向始终向上\r\n        if (newVelocity.y < 0) {\r\n            newVelocity.y = Math.abs(newVelocity.y);\r\n        }\r\n\r\n        // 防止完全垂直（90度）的情况\r\n        if (Math.abs(newVelocity.x) < speed * 0.1) {\r\n            newVelocity.x = speed * 0.1 * (Math.random() > 0.5 ? 1 : -1);\r\n            // 重新归一化并恢复速度\r\n            const normalized = newVelocity.normalize();\r\n            newVelocity.x = normalized.x * speed;\r\n            newVelocity.y = normalized.y * speed;\r\n        }\r\n\r\n        this._rigidBody.linearVelocity = newVelocity;\r\n\r\n        console.log(`Paddle hit - Offset: ${clampedOffset.toFixed(2)}, Angle: ${(targetAngle * 180 / Math.PI).toFixed(1)}°, Velocity: (${newVelocity.x.toFixed(1)}, ${newVelocity.y.toFixed(1)})`);\r\n    }\r\n\r\n    public get velocity(): Vec2 {\r\n        return this._rigidBody ? this._rigidBody.linearVelocity : new Vec2(0, 0);\r\n    }\r\n\r\n    public set velocity(value: Vec2) {\r\n        if (this._rigidBody) {\r\n            this._rigidBody.linearVelocity = value;\r\n        }\r\n    }\r\n}"]}