{"version":3,"sources":["file:///E:/work_space/wx/Cat_Journey/assets/scripts/AdManager.ts"],"names":["_decorator","Component","sys","ccclass","property","AdRewardType","AdPlacement","AdManager","_adConfigs","Map","_adStats","_adUnitIds","rewardVideo","interstitial","banner","_rewardedVideoAd","_interstitialAd","_bannerAd","_adsRemoved","onLoad","initializeAdConfigs","loadAdStats","initializeWeChatAds","set","LEVEL_FAILED","placement","rewardType","CONTINUE_GAME","title","description","rewardAmount","cooldownSeconds","maxPerDay","LEVEL_COMPLETE","DOUBLE_COINS","SHOP_BOOST","DAMAGE_BOOST","ENERGY_SHORTAGE","ENERGY_REFILL","DAILY_REWARD","FREE_GEMS","UPGRADE_STATION","UPGRADE_DISCOUNT","TREASURE_DOUBLE","MYSTERY_BOX","BOSS_PREPARATION","EXTRA_LIFE","MAIN_MENU","RARE_RELIC","PAUSE_MENU","SPEED_BOOST","platform","Platform","WECHAT_GAME","console","log","wx","createRewardedVideoAd","adUnitId","onError","err","error","onClose","res","isEnded","createInterstitialAd","createBannerAd","style","left","top","width","showRewardedAd","Promise","resolve","grantAdReward","config","get","canShowAd","recordAdShown","show","then","onAdClose","offClose","recordAdWatched","recordAdSkipped","catch","setTimeout","showInterstitialAd","showBannerAd","hideBannerAd","hide","stats","resetDailyCountIfNeeded","dailyCount","now","Date","cooldownMs","lastShownTime","getAdConfig","getRemainingCooldown","elapsed","Math","max","ceil","getRemainingDailyCount","setAdsRemoved","removed","saveAdStats","isAdsRemoved","node","emit","amount","totalShown","totalWatched","totalSkipped","lastResetDate","toDateString","today","data","Array","from","entries","adsRemoved","localStorage","setItem","JSON","stringify","getItem","parsed","parse","keys","has","getAdStats","allStats","place","watchRate","toFixed","resetStats","delete","clear"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, sys } from 'cc';\r\n\r\n// WeChat Mini Game API types\r\ndeclare const wx: WechatMinigame.Wx;\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\nexport enum AdRewardType {\r\n    DOUBLE_COINS = 'double_coins',           // 双倍金币\r\n    EXTRA_LIFE = 'extra_life',              // 额外生命\r\n    DAMAGE_BOOST = 'damage_boost',          // 攻击力提升\r\n    SPEED_BOOST = 'speed_boost',            // 速度提升\r\n    ENERGY_REFILL = 'energy_refill',        // 体力恢复\r\n    RARE_RELIC = 'rare_relic',              // 稀有遗物\r\n    CONTINUE_GAME = 'continue_game',         // 复活继续\r\n    UPGRADE_DISCOUNT = 'upgrade_discount',   // 升级折扣\r\n    MYSTERY_BOX = 'mystery_box',            // 神秘宝箱\r\n    FREE_GEMS = 'free_gems'                 // 免费宝石\r\n}\r\n\r\nexport enum AdPlacement {\r\n    LEVEL_FAILED = 'level_failed',          // 关卡失败时\r\n    LEVEL_COMPLETE = 'level_complete',      // 关卡完成时\r\n    SHOP_BOOST = 'shop_boost',              // 商店增益\r\n    MAIN_MENU = 'main_menu',                // 主菜单\r\n    PAUSE_MENU = 'pause_menu',              // 暂停菜单\r\n    DAILY_REWARD = 'daily_reward',          // 每日奖励\r\n    ENERGY_SHORTAGE = 'energy_shortage',    // 体力不足时\r\n    UPGRADE_STATION = 'upgrade_station',    // 升级站\r\n    TREASURE_DOUBLE = 'treasure_double',    // 宝箱奖励翻倍\r\n    BOSS_PREPARATION = 'boss_preparation'   // Boss战准备\r\n}\r\n\r\ninterface AdConfig {\r\n    placement: AdPlacement;\r\n    rewardType: AdRewardType;\r\n    title: string;\r\n    description: string;\r\n    rewardAmount: number;\r\n    cooldownSeconds: number;\r\n    maxPerDay: number;\r\n}\r\n\r\ninterface AdStats {\r\n    totalShown: number;\r\n    totalWatched: number;\r\n    totalSkipped: number;\r\n    lastShownTime: number;\r\n    dailyCount: number;\r\n    lastResetDate: string;\r\n}\r\n\r\n@ccclass('AdManager')\r\nexport class AdManager extends Component {\r\n    \r\n    // 广告配置\r\n    private _adConfigs: Map<AdPlacement, AdConfig> = new Map();\r\n    \r\n    // 广告统计\r\n    private _adStats: Map<AdPlacement, AdStats> = new Map();\r\n    \r\n    // 广告单元ID (微信小游戏)\r\n    private _adUnitIds = {\r\n        rewardVideo: 'adunit-xxxxxxxxxxxxxxx',  // 激励视频广告\r\n        interstitial: 'adunit-yyyyyyyyyyyyyyy', // 插屏广告\r\n        banner: 'adunit-zzzzzzzzzzzzzzz'        // 横幅广告\r\n    };\r\n    \r\n    // 广告实例缓存\r\n    private _rewardedVideoAd: any = null;\r\n    private _interstitialAd: any = null;\r\n    private _bannerAd: any = null;\r\n    \r\n    // 是否已移除广告\r\n    private _adsRemoved: boolean = false;\r\n    \r\n    protected onLoad(): void {\r\n        this.initializeAdConfigs();\r\n        this.loadAdStats();\r\n        this.initializeWeChatAds();\r\n    }\r\n    \r\n    private initializeAdConfigs(): void {\r\n        // 关卡失败 - 复活机会\r\n        this._adConfigs.set(AdPlacement.LEVEL_FAILED, {\r\n            placement: AdPlacement.LEVEL_FAILED,\r\n            rewardType: AdRewardType.CONTINUE_GAME,\r\n            title: \"观看广告复活\",\r\n            description: \"观看广告获得一次复活机会，保留当前进度继续游戏\",\r\n            rewardAmount: 1,\r\n            cooldownSeconds: 0,\r\n            maxPerDay: 5\r\n        });\r\n        \r\n        // 关卡完成 - 双倍奖励\r\n        this._adConfigs.set(AdPlacement.LEVEL_COMPLETE, {\r\n            placement: AdPlacement.LEVEL_COMPLETE,\r\n            rewardType: AdRewardType.DOUBLE_COINS,\r\n            title: \"双倍金币奖励\",\r\n            description: \"观看广告获得双倍金币奖励\",\r\n            rewardAmount: 2,\r\n            cooldownSeconds: 0,\r\n            maxPerDay: 10\r\n        });\r\n        \r\n        // 商店增益\r\n        this._adConfigs.set(AdPlacement.SHOP_BOOST, {\r\n            placement: AdPlacement.SHOP_BOOST,\r\n            rewardType: AdRewardType.DAMAGE_BOOST,\r\n            title: \"临时攻击力提升\",\r\n            description: \"观看广告获得10分钟50%攻击力加成\",\r\n            rewardAmount: 50,\r\n            cooldownSeconds: 600, // 10分钟冷却\r\n            maxPerDay: 8\r\n        });\r\n        \r\n        // 体力不足\r\n        this._adConfigs.set(AdPlacement.ENERGY_SHORTAGE, {\r\n            placement: AdPlacement.ENERGY_SHORTAGE,\r\n            rewardType: AdRewardType.ENERGY_REFILL,\r\n            title: \"免费体力恢复\",\r\n            description: \"观看广告立即恢复30点体力\",\r\n            rewardAmount: 30,\r\n            cooldownSeconds: 1800, // 30分钟冷却\r\n            maxPerDay: 6\r\n        });\r\n        \r\n        // 每日奖励\r\n        this._adConfigs.set(AdPlacement.DAILY_REWARD, {\r\n            placement: AdPlacement.DAILY_REWARD,\r\n            rewardType: AdRewardType.FREE_GEMS,\r\n            title: \"每日免费宝石\",\r\n            description: \"观看广告获得10个免费宝石\",\r\n            rewardAmount: 10,\r\n            cooldownSeconds: 86400, // 24小时冷却\r\n            maxPerDay: 1\r\n        });\r\n        \r\n        // 升级站折扣\r\n        this._adConfigs.set(AdPlacement.UPGRADE_STATION, {\r\n            placement: AdPlacement.UPGRADE_STATION,\r\n            rewardType: AdRewardType.UPGRADE_DISCOUNT,\r\n            title: \"升级费用减半\",\r\n            description: \"观看广告获得下次升级50%折扣\",\r\n            rewardAmount: 50,\r\n            cooldownSeconds: 3600, // 1小时冷却\r\n            maxPerDay: 4\r\n        });\r\n        \r\n        // 宝箱奖励翻倍\r\n        this._adConfigs.set(AdPlacement.TREASURE_DOUBLE, {\r\n            placement: AdPlacement.TREASURE_DOUBLE,\r\n            rewardType: AdRewardType.MYSTERY_BOX,\r\n            title: \"宝箱奖励翻倍\",\r\n            description: \"观看广告将宝箱奖励翻倍\",\r\n            rewardAmount: 2,\r\n            cooldownSeconds: 0,\r\n            maxPerDay: 8\r\n        });\r\n        \r\n        // Boss战准备\r\n        this._adConfigs.set(AdPlacement.BOSS_PREPARATION, {\r\n            placement: AdPlacement.BOSS_PREPARATION,\r\n            rewardType: AdRewardType.EXTRA_LIFE,\r\n            title: \"额外生命值\",\r\n            description: \"观看广告为Boss战获得额外生命值\",\r\n            rewardAmount: 1,\r\n            cooldownSeconds: 0,\r\n            maxPerDay: 3\r\n        });\r\n        \r\n        // 主菜单稀有遗物\r\n        this._adConfigs.set(AdPlacement.MAIN_MENU, {\r\n            placement: AdPlacement.MAIN_MENU,\r\n            rewardType: AdRewardType.RARE_RELIC,\r\n            title: \"免费稀有遗物\",\r\n            description: \"观看广告获得一个稀有品质遗物\",\r\n            rewardAmount: 1,\r\n            cooldownSeconds: 7200, // 2小时冷却\r\n            maxPerDay: 3\r\n        });\r\n        \r\n        // 暂停菜单速度提升\r\n        this._adConfigs.set(AdPlacement.PAUSE_MENU, {\r\n            placement: AdPlacement.PAUSE_MENU,\r\n            rewardType: AdRewardType.SPEED_BOOST,\r\n            title: \"速度提升\",\r\n            description: \"观看广告获得5分钟30%速度加成\",\r\n            rewardAmount: 30,\r\n            cooldownSeconds: 300, // 5分钟冷却\r\n            maxPerDay: 6\r\n        });\r\n    }\r\n    \r\n    private initializeWeChatAds(): void {\r\n        if (sys.platform !== sys.Platform.WECHAT_GAME) {\r\n            console.log('Not in WeChat environment, using mock ads');\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            // 激励视频广告\r\n            this._rewardedVideoAd = wx.createRewardedVideoAd({\r\n                adUnitId: this._adUnitIds.rewardVideo\r\n            });\r\n            \r\n            this._rewardedVideoAd.onLoad(() => {\r\n                console.log('Rewarded video ad loaded');\r\n            });\r\n            \r\n            this._rewardedVideoAd.onError((err: any) => {\r\n                console.error('Rewarded video ad error:', err);\r\n            });\r\n            \r\n            this._rewardedVideoAd.onClose((res: any) => {\r\n                if (res && res.isEnded) {\r\n                    console.log('Rewarded video ad watched completely');\r\n                } else {\r\n                    console.log('Rewarded video ad closed early');\r\n                }\r\n            });\r\n            \r\n            // 插屏广告\r\n            this._interstitialAd = wx.createInterstitialAd({\r\n                adUnitId: this._adUnitIds.interstitial\r\n            });\r\n            \r\n            this._interstitialAd.onLoad(() => {\r\n                console.log('Interstitial ad loaded');\r\n            });\r\n            \r\n            this._interstitialAd.onError((err: any) => {\r\n                console.error('Interstitial ad error:', err);\r\n            });\r\n            \r\n            // 横幅广告\r\n            this._bannerAd = wx.createBannerAd({\r\n                adUnitId: this._adUnitIds.banner,\r\n                style: {\r\n                    left: 0,\r\n                    top: 0,\r\n                    width: 320\r\n                }\r\n            });\r\n            \r\n        } catch (error) {\r\n            console.error('Failed to initialize WeChat ads:', error);\r\n        }\r\n    }\r\n    \r\n    // 显示激励视频广告\r\n    public showRewardedAd(placement: AdPlacement): Promise<boolean> {\r\n        return new Promise((resolve) => {\r\n            if (this._adsRemoved) {\r\n                // 如果已移除广告，直接给予奖励\r\n                this.grantAdReward(placement);\r\n                resolve(true);\r\n                return;\r\n            }\r\n            \r\n            const config = this._adConfigs.get(placement);\r\n            if (!config) {\r\n                console.error(`Ad config not found for placement: ${placement}`);\r\n                resolve(false);\r\n                return;\r\n            }\r\n            \r\n            // 检查冷却时间和每日限制\r\n            if (!this.canShowAd(placement)) {\r\n                resolve(false);\r\n                return;\r\n            }\r\n            \r\n            // 记录广告展示\r\n            this.recordAdShown(placement);\r\n            \r\n            if (sys.platform === sys.Platform.WECHAT_GAME && this._rewardedVideoAd) {\r\n                // 微信环境显示真实广告\r\n                this._rewardedVideoAd.show().then(() => {\r\n                    // 等待广告完成回调\r\n                    const onAdClose = (res: any) => {\r\n                        this._rewardedVideoAd.offClose(onAdClose);\r\n                        \r\n                        if (res && res.isEnded) {\r\n                            this.recordAdWatched(placement);\r\n                            this.grantAdReward(placement);\r\n                            resolve(true);\r\n                        } else {\r\n                            this.recordAdSkipped(placement);\r\n                            resolve(false);\r\n                        }\r\n                    };\r\n                    \r\n                    this._rewardedVideoAd.onClose(onAdClose);\r\n                }).catch((err: any) => {\r\n                    console.error('Failed to show rewarded video:', err);\r\n                    resolve(false);\r\n                });\r\n            } else {\r\n                // 开发环境或其他平台模拟观看\r\n                console.log(`Mock ad watched: ${placement}`);\r\n                setTimeout(() => {\r\n                    this.recordAdWatched(placement);\r\n                    this.grantAdReward(placement);\r\n                    resolve(true);\r\n                }, 1000); // 模拟1秒广告时间\r\n            }\r\n        });\r\n    }\r\n    \r\n    // 显示插屏广告\r\n    public showInterstitialAd(): Promise<boolean> {\r\n        return new Promise((resolve) => {\r\n            if (this._adsRemoved) {\r\n                resolve(true);\r\n                return;\r\n            }\r\n            \r\n            if (sys.platform === sys.Platform.WECHAT_GAME && this._interstitialAd) {\r\n                this._interstitialAd.show().then(() => {\r\n                    console.log('Interstitial ad shown');\r\n                    resolve(true);\r\n                }).catch((err: any) => {\r\n                    console.error('Failed to show interstitial:', err);\r\n                    resolve(false);\r\n                });\r\n            } else {\r\n                console.log('Mock interstitial ad shown');\r\n                resolve(true);\r\n            }\r\n        });\r\n    }\r\n    \r\n    // 显示横幅广告\r\n    public showBannerAd(): void {\r\n        if (this._adsRemoved || sys.platform !== sys.Platform.WECHAT_GAME) {\r\n            return;\r\n        }\r\n        \r\n        if (this._bannerAd) {\r\n            this._bannerAd.show().catch((err: any) => {\r\n                console.error('Failed to show banner ad:', err);\r\n            });\r\n        }\r\n    }\r\n    \r\n    // 隐藏横幅广告\r\n    public hideBannerAd(): void {\r\n        if (this._bannerAd) {\r\n            this._bannerAd.hide();\r\n        }\r\n    }\r\n    \r\n    // 检查是否可以显示广告\r\n    public canShowAd(placement: AdPlacement): boolean {\r\n        const config = this._adConfigs.get(placement);\r\n        const stats = this._adStats.get(placement);\r\n        \r\n        if (!config || !stats) return false;\r\n        \r\n        // 检查每日限制\r\n        this.resetDailyCountIfNeeded(placement);\r\n        if (stats.dailyCount >= config.maxPerDay) {\r\n            return false;\r\n        }\r\n        \r\n        // 检查冷却时间\r\n        const now = Date.now();\r\n        const cooldownMs = config.cooldownSeconds * 1000;\r\n        if (now - stats.lastShownTime < cooldownMs) {\r\n            return false;\r\n        }\r\n        \r\n        return true;\r\n    }\r\n    \r\n    // 获取广告配置\r\n    public getAdConfig(placement: AdPlacement): AdConfig | undefined {\r\n        return this._adConfigs.get(placement);\r\n    }\r\n    \r\n    // 获取剩余冷却时间\r\n    public getRemainingCooldown(placement: AdPlacement): number {\r\n        const config = this._adConfigs.get(placement);\r\n        const stats = this._adStats.get(placement);\r\n        \r\n        if (!config || !stats) return 0;\r\n        \r\n        const now = Date.now();\r\n        const cooldownMs = config.cooldownSeconds * 1000;\r\n        const elapsed = now - stats.lastShownTime;\r\n        \r\n        return Math.max(0, Math.ceil((cooldownMs - elapsed) / 1000));\r\n    }\r\n    \r\n    // 获取今日剩余次数\r\n    public getRemainingDailyCount(placement: AdPlacement): number {\r\n        const config = this._adConfigs.get(placement);\r\n        const stats = this._adStats.get(placement);\r\n        \r\n        if (!config || !stats) return 0;\r\n        \r\n        this.resetDailyCountIfNeeded(placement);\r\n        return Math.max(0, config.maxPerDay - stats.dailyCount);\r\n    }\r\n    \r\n    // 设置广告移除状态\r\n    public setAdsRemoved(removed: boolean): void {\r\n        this._adsRemoved = removed;\r\n        this.saveAdStats();\r\n        \r\n        if (removed) {\r\n            this.hideBannerAd();\r\n        }\r\n    }\r\n    \r\n    public isAdsRemoved(): boolean {\r\n        return this._adsRemoved;\r\n    }\r\n    \r\n    // 私有方法\r\n    private grantAdReward(placement: AdPlacement): void {\r\n        const config = this._adConfigs.get(placement);\r\n        if (!config) return;\r\n        \r\n        // 通知外部系统发放奖励\r\n        this.node.emit('ad-reward-granted', {\r\n            placement: placement,\r\n            rewardType: config.rewardType,\r\n            amount: config.rewardAmount\r\n        });\r\n        \r\n        console.log(`Ad reward granted: ${config.rewardType}, amount: ${config.rewardAmount}`);\r\n    }\r\n    \r\n    private recordAdShown(placement: AdPlacement): void {\r\n        let stats = this._adStats.get(placement);\r\n        if (!stats) {\r\n            stats = {\r\n                totalShown: 0,\r\n                totalWatched: 0,\r\n                totalSkipped: 0,\r\n                lastShownTime: 0,\r\n                dailyCount: 0,\r\n                lastResetDate: new Date().toDateString()\r\n            };\r\n            this._adStats.set(placement, stats);\r\n        }\r\n        \r\n        stats.totalShown++;\r\n        stats.lastShownTime = Date.now();\r\n        stats.dailyCount++;\r\n        \r\n        this.saveAdStats();\r\n    }\r\n    \r\n    private recordAdWatched(placement: AdPlacement): void {\r\n        const stats = this._adStats.get(placement);\r\n        if (stats) {\r\n            stats.totalWatched++;\r\n            this.saveAdStats();\r\n        }\r\n    }\r\n    \r\n    private recordAdSkipped(placement: AdPlacement): void {\r\n        const stats = this._adStats.get(placement);\r\n        if (stats) {\r\n            stats.totalSkipped++;\r\n            stats.dailyCount--; // 跳过的广告不计入每日限制\r\n            this.saveAdStats();\r\n        }\r\n    }\r\n    \r\n    private resetDailyCountIfNeeded(placement: AdPlacement): void {\r\n        const stats = this._adStats.get(placement);\r\n        if (!stats) return;\r\n        \r\n        const today = new Date().toDateString();\r\n        if (stats.lastResetDate !== today) {\r\n            stats.dailyCount = 0;\r\n            stats.lastResetDate = today;\r\n        }\r\n    }\r\n    \r\n    private saveAdStats(): void {\r\n        const data = {\r\n            stats: Array.from(this._adStats.entries()),\r\n            adsRemoved: this._adsRemoved\r\n        };\r\n        \r\n        sys.localStorage.setItem('ad_manager_data', JSON.stringify(data));\r\n    }\r\n    \r\n    private loadAdStats(): void {\r\n        const data = sys.localStorage.getItem('ad_manager_data');\r\n        if (data) {\r\n            const parsed = JSON.parse(data);\r\n            \r\n            if (parsed.stats) {\r\n                this._adStats = new Map(parsed.stats);\r\n            }\r\n            \r\n            this._adsRemoved = parsed.adsRemoved || false;\r\n        }\r\n        \r\n        // 初始化所有placement的统计数据\r\n        for (const placement of this._adConfigs.keys()) {\r\n            if (!this._adStats.has(placement)) {\r\n                this._adStats.set(placement, {\r\n                    totalShown: 0,\r\n                    totalWatched: 0,\r\n                    totalSkipped: 0,\r\n                    lastShownTime: 0,\r\n                    dailyCount: 0,\r\n                    lastResetDate: new Date().toDateString()\r\n                });\r\n            }\r\n        }\r\n    }\r\n    \r\n    // 获取广告统计数据\r\n    public getAdStats(placement?: AdPlacement): any {\r\n        if (placement) {\r\n            return this._adStats.get(placement);\r\n        }\r\n        \r\n        // 返回所有统计数据\r\n        const allStats: any = {};\r\n        for (const [place, stats] of this._adStats.entries()) {\r\n            allStats[place] = {\r\n                ...stats,\r\n                watchRate: stats.totalShown > 0 ? (stats.totalWatched / stats.totalShown * 100).toFixed(1) + '%' : '0%'\r\n            };\r\n        }\r\n        \r\n        return allStats;\r\n    }\r\n    \r\n    // 重置统计数据(调试用)\r\n    public resetStats(placement?: AdPlacement): void {\r\n        if (placement) {\r\n            this._adStats.delete(placement);\r\n        } else {\r\n            this._adStats.clear();\r\n        }\r\n        \r\n        this.loadAdStats(); // 重新初始化\r\n    }\r\n}"]}