{"version":3,"sources":["file:///E:/work_space/wx/Cat_Journey/assets/scripts/MonetizationManager.ts"],"names":["_decorator","Component","sys","ccclass","property","CurrencyType","PurchaseType","AdType","MonetizationManager","_currencies","Map","_purchaseItems","_isVIP","_vipExpireTime","_adsRemoved","_lastAdTime","_difficultyScaling","chapter1","easy","medium","hard","chapter2","chapter3","_monetizationBoosts","adBoostDamage","adBoostSpeed","adBoostCurrency","vipExpBonus","vipCurrencyBonus","vipEnergyRegenBonus","onLoad","initializeCurrencies","initializePurchaseItems","loadPlayerData","scheduleEnergyRegeneration","set","COINS","type","amount","maxAmount","GEMS","ENERGY","regenRate","lastRegenTime","Date","now","EXPERIENCE","REMOVE_ADS","id","name","description","price","value","removeAds","oneTime","VIP_MONTHLY","vipDays","STARTER_PACK","gems","items","paddle","discountPercent","GEMS_SMALL","GEMS_MEDIUM","GEMS_LARGE","ENERGY_REFILL","currency","currencyAmount","energyRefill","LEGENDARY_PADDLE","paddleType","stats","damage","durability","autoRepair","vipOnly","LEGENDARY_BALL","ballType","effects","LEGENDARY_CORE","coreType","health","damageReduction","LEGENDARY_RELIC","relicTier","random","getCurrency","get","addCurrency","newAmount","Number","MAX_SAFE_INTEGER","Math","min","savePlayerData","bonus","floor","subtractCurrency","schedule","regenerateEnergy","energyData","hoursSinceLastRegen","regenAmount","purchaseItem","purchaseType","item","console","error","Promise","resolve","warn","hasPurchased","applyPurchaseReward","recordPurchase","processRealMoneyPurchase","platform","Platform","WECHAT_GAME","wx","requestPayment","timeStamp","toString","nonceStr","generateNonceStr","package","generatePrepayId","signType","paySign","generatePaySign","success","res","log","fail","err","vipDuration","max","grantLegendaryItem","grantRandomRelic","showRewardedAd","adType","reward","applyAdReward","createRewardedVideoAd","adUnitId","getAdUnitId","show","then","catch","itemType","grantItemReward","itemData","getAdDamageBoost","getAdSpeedBoost","requestTemporaryBoost","boostType","duration","REWARD_VIDEO","isVIP","getVIPExpireTime","analyzeDifficultyBalancing","earlyGame","difficultyMultiplier","currencyGainRate","energyCost","adFrequency","paymentPressure","midGame","lateGame","optimization","suggestion","metrics","retentionRate","conversionRate","arpu","substr","adUnits","INTERSTITIAL","BANNER","tier","purchases","getPurchaseHistory","push","timestamp","localStorage","setItem","JSON","stringify","some","p","data","getItem","parse","currencies","Array","from","entries","vipExpireTime","adsRemoved","lastAdTimes","parsed","currencyData","getAllCurrencies","getPurchaseItems","values","canAfford","getDifficultyMultiplier","chapter","playerLevel","chapterKey","scaling"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, sys } from 'cc';\r\n\r\n// WeChat Mini Game API types\r\ndeclare const wx: WechatMinigame.Wx;\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\nexport enum CurrencyType {\r\n    COINS = 'coins',              // 金币 - 通过游戏获得\r\n    GEMS = 'gems',                // 宝石 - 付费货币\r\n    ENERGY = 'energy',            // 体力 - 限制游戏次数\r\n    EXPERIENCE = 'experience'     // 经验 - 用于升级\r\n}\r\n\r\nexport enum PurchaseType {\r\n    REMOVE_ADS = 'remove_ads',              // 去广告\r\n    VIP_MONTHLY = 'vip_monthly',           // 月度VIP\r\n    STARTER_PACK = 'starter_pack',         // 新手礼包\r\n    GEMS_SMALL = 'gems_small',             // 小宝石包\r\n    GEMS_MEDIUM = 'gems_medium',           // 中宝石包\r\n    GEMS_LARGE = 'gems_large',             // 大宝石包\r\n    ENERGY_REFILL = 'energy_refill',       // 体力恢复\r\n    LEGENDARY_PADDLE = 'legendary_paddle',  // 传说挡板\r\n    LEGENDARY_BALL = 'legendary_ball',      // 传说弹球\r\n    LEGENDARY_CORE = 'legendary_core',      // 传说核心\r\n    LEGENDARY_RELIC = 'legendary_relic'     // 传说遗物\r\n}\r\n\r\nexport enum AdType {\r\n    REWARD_VIDEO = 'reward_video',         // 奖励视频\r\n    INTERSTITIAL = 'interstitial',        // 插屏广告\r\n    BANNER = 'banner'                      // 横幅广告\r\n}\r\n\r\ninterface CurrencyData {\r\n    type: CurrencyType;\r\n    amount: number;\r\n    maxAmount?: number;\r\n    regenRate?: number;        // 每小时恢复数量\r\n    lastRegenTime?: number;    // 上次恢复时间\r\n}\r\n\r\ninterface PurchaseItem {\r\n    id: PurchaseType;\r\n    name: string;\r\n    description: string;\r\n    price: number;             // RMB价格（分）\r\n    currency?: CurrencyType;   // 游戏内货币类型\r\n    currencyAmount?: number;   // 游戏内货币价格\r\n    value: any;               // 购买内容\r\n    oneTime?: boolean;        // 是否一次性购买\r\n    vipOnly?: boolean;        // 是否VIP专属\r\n    discountPercent?: number; // 折扣百分比\r\n}\r\n\r\ninterface AdReward {\r\n    type: CurrencyType | 'item';\r\n    amount?: number;\r\n    itemType?: string;\r\n    itemData?: any;\r\n}\r\n\r\n@ccclass('MonetizationManager')\r\nexport class MonetizationManager extends Component {\r\n    \r\n    // 货币系统\r\n    private _currencies: Map<CurrencyType, CurrencyData> = new Map();\r\n    \r\n    // 购买项目配置\r\n    private _purchaseItems: Map<PurchaseType, PurchaseItem> = new Map();\r\n    \r\n    // VIP状态\r\n    private _isVIP: boolean = false;\r\n    private _vipExpireTime: number = 0;\r\n    \r\n    // 广告状态\r\n    private _adsRemoved: boolean = false;\r\n    private _lastAdTime: Map<AdType, number> = new Map();\r\n    \r\n    // 游戏平衡参数\r\n    private _difficultyScaling = {\r\n        chapter1: { easy: 1.0, medium: 1.2, hard: 1.5 },\r\n        chapter2: { easy: 1.3, medium: 1.6, hard: 2.0 },\r\n        chapter3: { easy: 1.8, medium: 2.3, hard: 3.0 }\r\n    };\r\n    \r\n    // 付费增益参数\r\n    private _monetizationBoosts = {\r\n        adBoostDamage: 1.5,           // 看广告伤害提升\r\n        adBoostSpeed: 1.3,            // 看广告速度提升\r\n        adBoostCurrency: 2.0,         // 看广告货币翻倍\r\n        vipExpBonus: 2.0,            // VIP经验加成\r\n        vipCurrencyBonus: 1.5,       // VIP货币加成\r\n        vipEnergyRegenBonus: 2.0     // VIP体力恢复加成\r\n    };\r\n    \r\n    protected onLoad(): void {\r\n        this.initializeCurrencies();\r\n        this.initializePurchaseItems();\r\n        this.loadPlayerData();\r\n        this.scheduleEnergyRegeneration();\r\n    }\r\n    \r\n    private initializeCurrencies(): void {\r\n        // 金币 - 主要游戏货币\r\n        this._currencies.set(CurrencyType.COINS, {\r\n            type: CurrencyType.COINS,\r\n            amount: 100,    // 初始100金币\r\n            maxAmount: 999999\r\n        });\r\n        \r\n        // 宝石 - 付费货币\r\n        this._currencies.set(CurrencyType.GEMS, {\r\n            type: CurrencyType.GEMS,\r\n            amount: 10,     // 初始10宝石\r\n            maxAmount: 99999\r\n        });\r\n        \r\n        // 体力 - 限制游戏次数\r\n        this._currencies.set(CurrencyType.ENERGY, {\r\n            type: CurrencyType.ENERGY,\r\n            amount: 100,    // 初始满体力\r\n            maxAmount: 100,\r\n            regenRate: 20,  // 每小时恢复20点\r\n            lastRegenTime: Date.now()\r\n        });\r\n        \r\n        // 经验\r\n        this._currencies.set(CurrencyType.EXPERIENCE, {\r\n            type: CurrencyType.EXPERIENCE,\r\n            amount: 0,\r\n            maxAmount: 999999\r\n        });\r\n    }\r\n    \r\n    private initializePurchaseItems(): void {\r\n        // 功能性购买\r\n        this._purchaseItems.set(PurchaseType.REMOVE_ADS, {\r\n            id: PurchaseType.REMOVE_ADS,\r\n            name: \"移除广告\",\r\n            description: \"永久移除所有广告，享受纯净游戏体验\",\r\n            price: 1200,    // 12元\r\n            value: { removeAds: true },\r\n            oneTime: true\r\n        });\r\n        \r\n        this._purchaseItems.set(PurchaseType.VIP_MONTHLY, {\r\n            id: PurchaseType.VIP_MONTHLY,\r\n            name: \"月度VIP\",\r\n            description: \"30天VIP特权：双倍经验、体力恢复+100%、专属商店\",\r\n            price: 3000,    // 30元\r\n            value: { vipDays: 30 },\r\n            oneTime: false\r\n        });\r\n        \r\n        // 新手礼包\r\n        this._purchaseItems.set(PurchaseType.STARTER_PACK, {\r\n            id: PurchaseType.STARTER_PACK,\r\n            name: \"新手特惠礼包\",\r\n            description: \"包含1000宝石、传说遗物、能量恢复道具\",\r\n            price: 600,     // 6元\r\n            value: {\r\n                gems: 1000,\r\n                items: ['legendary_relic_starter', 'energy_potion_large'],\r\n                paddle: 'enhanced_starter_paddle'\r\n            },\r\n            oneTime: true,\r\n            discountPercent: 80  // 80%折扣\r\n        });\r\n        \r\n        // 宝石包\r\n        this._purchaseItems.set(PurchaseType.GEMS_SMALL, {\r\n            id: PurchaseType.GEMS_SMALL,\r\n            name: \"小宝石包\",\r\n            description: \"100宝石，物超所值\",\r\n            price: 600,     // 6元\r\n            value: { gems: 100 }\r\n        });\r\n        \r\n        this._purchaseItems.set(PurchaseType.GEMS_MEDIUM, {\r\n            id: PurchaseType.GEMS_MEDIUM,\r\n            name: \"中宝石包\",\r\n            description: \"600宝石，送100额外宝石\",\r\n            price: 3000,    // 30元\r\n            value: { gems: 700 }\r\n        });\r\n        \r\n        this._purchaseItems.set(PurchaseType.GEMS_LARGE, {\r\n            id: PurchaseType.GEMS_LARGE,\r\n            name: \"大宝石包\",\r\n            description: \"2000宝石，送500额外宝石\",\r\n            price: 9800,    // 98元\r\n            value: { gems: 2500 }\r\n        });\r\n        \r\n        // 体力恢复\r\n        this._purchaseItems.set(PurchaseType.ENERGY_REFILL, {\r\n            id: PurchaseType.ENERGY_REFILL,\r\n            name: \"体力恢复\",\r\n            description: \"立即恢复满体力\",\r\n            currency: CurrencyType.GEMS,\r\n            currencyAmount: 50,\r\n            value: { energyRefill: 100 }\r\n        });\r\n        \r\n        // 传说装备\r\n        this._purchaseItems.set(PurchaseType.LEGENDARY_PADDLE, {\r\n            id: PurchaseType.LEGENDARY_PADDLE,\r\n            name: \"传说挡板\",\r\n            description: \"『神话破坏者』- 攻击力+50%，耐久度+100%，自动修复\",\r\n            currency: CurrencyType.GEMS,\r\n            currencyAmount: 800,\r\n            value: {\r\n                paddleType: 'legendary_destroyer',\r\n                stats: { damage: 1.5, durability: 2.0, autoRepair: true }\r\n            },\r\n            vipOnly: false\r\n        });\r\n        \r\n        this._purchaseItems.set(PurchaseType.LEGENDARY_BALL, {\r\n            id: PurchaseType.LEGENDARY_BALL,\r\n            name: \"传说弹球\",\r\n            description: \"『混沌之球』- 随机获得3种球效果，穿透+无限反弹\",\r\n            currency: CurrencyType.GEMS,\r\n            currencyAmount: 1000,\r\n            value: {\r\n                ballType: 'legendary_chaos',\r\n                effects: ['piercing', 'infinite_bounce', 'random_effects']\r\n            }\r\n        });\r\n        \r\n        this._purchaseItems.set(PurchaseType.LEGENDARY_CORE, {\r\n            id: PurchaseType.LEGENDARY_CORE,\r\n            name: \"传说核心\",\r\n            description: \"『永恒之心』- 生命值+200%，被击中时25%几率免伤\",\r\n            currency: CurrencyType.GEMS,\r\n            currencyAmount: 1200,\r\n            value: {\r\n                coreType: 'legendary_eternal',\r\n                stats: { health: 3.0, damageReduction: 0.25 }\r\n            }\r\n        });\r\n        \r\n        this._purchaseItems.set(PurchaseType.LEGENDARY_RELIC, {\r\n            id: PurchaseType.LEGENDARY_RELIC,\r\n            name: \"传说遗物\",\r\n            description: \"随机获得一个传说级遗物，效果强大\",\r\n            currency: CurrencyType.GEMS,\r\n            currencyAmount: 600,\r\n            value: { relicTier: 'legendary', random: true }\r\n        });\r\n    }\r\n    \r\n    // 货币管理\r\n    public getCurrency(type: CurrencyType): number {\r\n        const currency = this._currencies.get(type);\r\n        return currency ? currency.amount : 0;\r\n    }\r\n    \r\n    public addCurrency(type: CurrencyType, amount: number): boolean {\r\n        const currency = this._currencies.get(type);\r\n        if (!currency) return false;\r\n        \r\n        const newAmount = currency.amount + amount;\r\n        const maxAmount = currency.maxAmount || Number.MAX_SAFE_INTEGER;\r\n        \r\n        currency.amount = Math.min(newAmount, maxAmount);\r\n        this.savePlayerData();\r\n        \r\n        // VIP加成\r\n        if (this._isVIP && (type === CurrencyType.COINS || type === CurrencyType.EXPERIENCE)) {\r\n            const bonus = Math.floor(amount * (this._monetizationBoosts.vipCurrencyBonus - 1));\r\n            currency.amount = Math.min(currency.amount + bonus, maxAmount);\r\n        }\r\n        \r\n        return true;\r\n    }\r\n    \r\n    public subtractCurrency(type: CurrencyType, amount: number): boolean {\r\n        const currency = this._currencies.get(type);\r\n        if (!currency || currency.amount < amount) {\r\n            return false;\r\n        }\r\n        \r\n        currency.amount -= amount;\r\n        this.savePlayerData();\r\n        return true;\r\n    }\r\n    \r\n    // 体力恢复系统\r\n    private scheduleEnergyRegeneration(): void {\r\n        this.schedule(this.regenerateEnergy, 60, Number.MAX_SAFE_INTEGER, 0); // 每分钟检查一次\r\n    }\r\n    \r\n    private regenerateEnergy(): void {\r\n        const energyData = this._currencies.get(CurrencyType.ENERGY);\r\n        if (!energyData || !energyData.regenRate || !energyData.lastRegenTime) return;\r\n        \r\n        const now = Date.now();\r\n        const hoursSinceLastRegen = (now - energyData.lastRegenTime) / (1000 * 60 * 60);\r\n        \r\n        if (hoursSinceLastRegen >= 1.0) {\r\n            let regenAmount = Math.floor(hoursSinceLastRegen * energyData.regenRate);\r\n            \r\n            // VIP加成\r\n            if (this._isVIP) {\r\n                regenAmount = Math.floor(regenAmount * this._monetizationBoosts.vipEnergyRegenBonus);\r\n            }\r\n            \r\n            if (regenAmount > 0) {\r\n                const newAmount = Math.min(energyData.amount + regenAmount, energyData.maxAmount!);\r\n                energyData.amount = newAmount;\r\n                energyData.lastRegenTime = now;\r\n                this.savePlayerData();\r\n            }\r\n        }\r\n    }\r\n    \r\n    // 购买系统\r\n    public purchaseItem(purchaseType: PurchaseType): Promise<boolean> {\r\n        const item = this._purchaseItems.get(purchaseType);\r\n        if (!item) {\r\n            console.error(`Purchase item not found: ${purchaseType}`);\r\n            return Promise.resolve(false);\r\n        }\r\n        \r\n        // 检查VIP权限\r\n        if (item.vipOnly && !this._isVIP) {\r\n            console.warn(`Item ${purchaseType} requires VIP`);\r\n            return Promise.resolve(false);\r\n        }\r\n        \r\n        // 检查是否已购买（一次性商品）\r\n        if (item.oneTime && this.hasPurchased(purchaseType)) {\r\n            console.warn(`Item ${purchaseType} already purchased`);\r\n            return Promise.resolve(false);\r\n        }\r\n        \r\n        // 游戏内货币购买\r\n        if (item.currency && item.currencyAmount) {\r\n            if (this.subtractCurrency(item.currency, item.currencyAmount)) {\r\n                this.applyPurchaseReward(item);\r\n                this.recordPurchase(purchaseType);\r\n                return Promise.resolve(true);\r\n            } else {\r\n                console.warn(`Insufficient ${item.currency} for ${purchaseType}`);\r\n                return Promise.resolve(false);\r\n            }\r\n        }\r\n        \r\n        // 真实货币购买 - 集成微信支付\r\n        return this.processRealMoneyPurchase(item);\r\n    }\r\n    \r\n    private processRealMoneyPurchase(item: PurchaseItem): Promise<boolean> {\r\n        return new Promise((resolve) => {\r\n            // 微信小游戏支付集成\r\n            if (sys.platform === sys.Platform.WECHAT_GAME) {\r\n                wx.requestPayment({\r\n                    timeStamp: Date.now().toString(),\r\n                    nonceStr: this.generateNonceStr(),\r\n                    package: `prepay_id=${this.generatePrepayId(item)}`,\r\n                    signType: 'MD5',\r\n                    paySign: this.generatePaySign(item),\r\n                    success: (res: any) => {\r\n                        console.log('Payment success:', res);\r\n                        this.applyPurchaseReward(item);\r\n                        this.recordPurchase(item.id);\r\n                        resolve(true);\r\n                    },\r\n                    fail: (err: any) => {\r\n                        console.error('Payment failed:', err);\r\n                        resolve(false);\r\n                    }\r\n                });\r\n            } else {\r\n                // 开发环境模拟购买成功\r\n                console.log(`Simulated purchase: ${item.name}`);\r\n                this.applyPurchaseReward(item);\r\n                this.recordPurchase(item.id);\r\n                resolve(true);\r\n            }\r\n        });\r\n    }\r\n    \r\n    private applyPurchaseReward(item: PurchaseItem): void {\r\n        const value = item.value;\r\n        \r\n        // 处理不同类型的奖励\r\n        if (value.removeAds) {\r\n            this._adsRemoved = true;\r\n        }\r\n        \r\n        if (value.vipDays) {\r\n            const now = Date.now();\r\n            const vipDuration = value.vipDays * 24 * 60 * 60 * 1000;\r\n            this._vipExpireTime = Math.max(now, this._vipExpireTime) + vipDuration;\r\n            this._isVIP = true;\r\n        }\r\n        \r\n        if (value.gems) {\r\n            this.addCurrency(CurrencyType.GEMS, value.gems);\r\n        }\r\n        \r\n        if (value.energyRefill) {\r\n            const energyData = this._currencies.get(CurrencyType.ENERGY)!;\r\n            energyData.amount = energyData.maxAmount!;\r\n        }\r\n        \r\n        // 处理装备奖励\r\n        if (value.paddleType || value.ballType || value.coreType) {\r\n            this.grantLegendaryItem(value);\r\n        }\r\n        \r\n        if (value.relicTier) {\r\n            this.grantRandomRelic(value.relicTier, value.random);\r\n        }\r\n        \r\n        this.savePlayerData();\r\n    }\r\n    \r\n    // 广告系统\r\n    public showRewardedAd(adType: AdType, reward: AdReward): Promise<boolean> {\r\n        if (this._adsRemoved) {\r\n            // 如果已移除广告，直接给奖励\r\n            this.applyAdReward(reward);\r\n            return Promise.resolve(true);\r\n        }\r\n        \r\n        return new Promise((resolve) => {\r\n            if (sys.platform === sys.Platform.WECHAT_GAME) {\r\n                wx.createRewardedVideoAd({\r\n                    adUnitId: this.getAdUnitId(adType)\r\n                }).show().then(() => {\r\n                    console.log('Rewarded ad shown');\r\n                    this.applyAdReward(reward);\r\n                    this._lastAdTime.set(adType, Date.now());\r\n                    resolve(true);\r\n                }).catch((err: any) => {\r\n                    console.error('Failed to show rewarded ad:', err);\r\n                    resolve(false);\r\n                });\r\n            } else {\r\n                // 开发环境模拟观看广告\r\n                console.log(`Simulated ad watch: ${adType}`);\r\n                this.applyAdReward(reward);\r\n                resolve(true);\r\n            }\r\n        });\r\n    }\r\n    \r\n    private applyAdReward(reward: AdReward): void {\r\n        if (reward.type !== 'item' && reward.amount) {\r\n            let amount = reward.amount;\r\n            \r\n            // 广告奖励可能有加成\r\n            if (this._isVIP) {\r\n                amount = Math.floor(amount * this._monetizationBoosts.vipCurrencyBonus);\r\n            }\r\n            \r\n            this.addCurrency(reward.type as CurrencyType, amount);\r\n        } else if (reward.type === 'item' && reward.itemType) {\r\n            this.grantItemReward(reward.itemType, reward.itemData);\r\n        }\r\n    }\r\n    \r\n    // 游戏增益系统\r\n    public getAdDamageBoost(): number {\r\n        return this._monetizationBoosts.adBoostDamage;\r\n    }\r\n    \r\n    public getAdSpeedBoost(): number {\r\n        return this._monetizationBoosts.adBoostSpeed;\r\n    }\r\n    \r\n    public requestTemporaryBoost(boostType: string, duration: number): Promise<boolean> {\r\n        const reward: AdReward = {\r\n            type: 'item',\r\n            itemType: `boost_${boostType}`,\r\n            itemData: { duration: duration }\r\n        };\r\n        \r\n        return this.showRewardedAd(AdType.REWARD_VIDEO, reward);\r\n    }\r\n    \r\n    // VIP系统\r\n    public isVIP(): boolean {\r\n        if (this._vipExpireTime > 0 && Date.now() > this._vipExpireTime) {\r\n            this._isVIP = false;\r\n            this._vipExpireTime = 0;\r\n            this.savePlayerData();\r\n        }\r\n        return this._isVIP;\r\n    }\r\n    \r\n    public getVIPExpireTime(): number {\r\n        return this._vipExpireTime;\r\n    }\r\n    \r\n    // 数值平衡分析\r\n    public analyzeDifficultyBalancing(): any {\r\n        return {\r\n            earlyGame: {\r\n                description: \"前期爽快体验设计\",\r\n                difficultyMultiplier: 1.0,\r\n                currencyGainRate: 1.5,\r\n                energyCost: 10,\r\n                adFrequency: \"低频率\",\r\n                paymentPressure: \"无\"\r\n            },\r\n            midGame: {\r\n                description: \"中期挑战增加\",\r\n                difficultyMultiplier: 1.8,\r\n                currencyGainRate: 1.0,\r\n                energyCost: 20,\r\n                adFrequency: \"中等频率\",\r\n                paymentPressure: \"引导购买VIP/宝石包\"\r\n            },\r\n            lateGame: {\r\n                description: \"后期高难度，强烈付费引导\",\r\n                difficultyMultiplier: 3.0,\r\n                currencyGainRate: 0.6,\r\n                energyCost: 30,\r\n                adFrequency: \"高频率\",\r\n                paymentPressure: \"传说装备/大量资源需求\"\r\n            },\r\n            optimization: {\r\n                suggestion: \"在第二章中期开始引入付费点，第三章强化付费收益\",\r\n                metrics: {\r\n                    retentionRate: \"通过合理难度曲线保持70%+留存\",\r\n                    conversionRate: \"目标5%付费转化率\",\r\n                    arpu: \"人均收入30-50元\"\r\n                }\r\n            }\r\n        };\r\n    }\r\n    \r\n    // 工具方法\r\n    private generateNonceStr(): string {\r\n        return Math.random().toString(36).substr(2, 15);\r\n    }\r\n    \r\n    private generatePrepayId(item: PurchaseItem): string {\r\n        return `prepay_${item.id}_${Date.now()}`;\r\n    }\r\n    \r\n    private generatePaySign(item: PurchaseItem): string {\r\n        // 实际实现需要根据微信支付规范生成签名\r\n        return `sign_${item.id}`;\r\n    }\r\n    \r\n    private getAdUnitId(adType: AdType): string {\r\n        // 返回对应的广告单元ID\r\n        const adUnits = {\r\n            [AdType.REWARD_VIDEO]: 'adunit-reward-video-id',\r\n            [AdType.INTERSTITIAL]: 'adunit-interstitial-id',\r\n            [AdType.BANNER]: 'adunit-banner-id'\r\n        };\r\n        return adUnits[adType] || '';\r\n    }\r\n    \r\n    private grantLegendaryItem(value: any): void {\r\n        // 发放传说装备\r\n        console.log('Granted legendary item:', value);\r\n    }\r\n    \r\n    private grantRandomRelic(tier: string, random: boolean): void {\r\n        // 发放随机遗物\r\n        console.log(`Granted ${tier} relic, random: ${random}`);\r\n    }\r\n    \r\n    private grantItemReward(itemType: string, itemData: any): void {\r\n        // 发放物品奖励\r\n        console.log(`Granted item: ${itemType}`, itemData);\r\n    }\r\n    \r\n    private recordPurchase(purchaseType: PurchaseType): void {\r\n        // 记录购买历史\r\n        const purchases = this.getPurchaseHistory();\r\n        purchases.push({\r\n            type: purchaseType,\r\n            timestamp: Date.now()\r\n        });\r\n        sys.localStorage.setItem('purchase_history', JSON.stringify(purchases));\r\n    }\r\n    \r\n    private hasPurchased(purchaseType: PurchaseType): boolean {\r\n        const purchases = this.getPurchaseHistory();\r\n        return purchases.some(p => p.type === purchaseType);\r\n    }\r\n    \r\n    private getPurchaseHistory(): any[] {\r\n        const data = sys.localStorage.getItem('purchase_history');\r\n        return data ? JSON.parse(data) : [];\r\n    }\r\n    \r\n    // 数据持久化\r\n    private savePlayerData(): void {\r\n        const data = {\r\n            currencies: Array.from(this._currencies.entries()),\r\n            isVIP: this._isVIP,\r\n            vipExpireTime: this._vipExpireTime,\r\n            adsRemoved: this._adsRemoved,\r\n            lastAdTimes: Array.from(this._lastAdTime.entries())\r\n        };\r\n        \r\n        sys.localStorage.setItem('monetization_data', JSON.stringify(data));\r\n    }\r\n    \r\n    private loadPlayerData(): void {\r\n        const data = sys.localStorage.getItem('monetization_data');\r\n        if (data) {\r\n            const parsed = JSON.parse(data);\r\n            \r\n            // 恢复货币数据\r\n            if (parsed.currencies) {\r\n                for (const [type, currencyData] of parsed.currencies) {\r\n                    this._currencies.set(type, currencyData);\r\n                }\r\n            }\r\n            \r\n            this._isVIP = parsed.isVIP || false;\r\n            this._vipExpireTime = parsed.vipExpireTime || 0;\r\n            this._adsRemoved = parsed.adsRemoved || false;\r\n            \r\n            if (parsed.lastAdTimes) {\r\n                this._lastAdTime = new Map(parsed.lastAdTimes);\r\n            }\r\n        }\r\n    }\r\n    \r\n    // 公开接口\r\n    public getAllCurrencies(): Map<CurrencyType, CurrencyData> {\r\n        return new Map(this._currencies);\r\n    }\r\n    \r\n    public getPurchaseItems(): PurchaseItem[] {\r\n        return Array.from(this._purchaseItems.values());\r\n    }\r\n    \r\n    public canAfford(purchaseType: PurchaseType): boolean {\r\n        const item = this._purchaseItems.get(purchaseType);\r\n        if (!item) return false;\r\n        \r\n        if (item.currency && item.currencyAmount) {\r\n            return this.getCurrency(item.currency) >= item.currencyAmount;\r\n        }\r\n        \r\n        return true; // 真实货币购买总是可以尝试\r\n    }\r\n    \r\n    public getDifficultyMultiplier(chapter: number, playerLevel: number): number {\r\n        const chapterKey = `chapter${chapter}` as keyof typeof this._difficultyScaling;\r\n        const scaling = this._difficultyScaling[chapterKey];\r\n        \r\n        if (!scaling) return 1.0;\r\n        \r\n        // 根据玩家等级调整难度\r\n        if (playerLevel < 10) return scaling.easy;\r\n        else if (playerLevel < 25) return scaling.medium;\r\n        else return scaling.hard;\r\n    }\r\n}"]}